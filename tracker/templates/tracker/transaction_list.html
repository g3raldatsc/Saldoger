{% extends 'tracker/base.html' %} 
{% load humanize %}
{% load crispy_forms_tags %} 

{% block content %}

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <div class="row">
        <div class="col-12 text-center mb-4">
            <h3 class="fw-bold" style="color: #1e3a8a;">Saldoger Dashboard</h3>
            <p class="text-muted">Kelola uangmu, atur masa depanmu.</p>
        </div>
    </div>

    <div class="alert alert-primary text-center shadow-sm border-0 mb-4" style="background: linear-gradient(to right, #2563eb, #1d4ed8); color: white;">
        <h5 class="mb-0">Saldo Saat Ini</h5>
        <h2 class="fw-bold">Rp {{ saldo|floatformat:2 }}</h2>
    </div>
    
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-0 pt-4 pb-0">
                    <h5 class="fw-bold text-primary"><i class="bi bi-plus-circle-fill"></i> Tambah Transaksi</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {% csrf_token %}
                        
                        {{ form|crispy }}
                        
                        <div class="d-grid mt-3">
                            <button type="submit" class="btn btn-primary fw-bold py-2">
                                + Simpan Transaksi
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <h5 class="fw-bold text-dark mb-3">Ringkasan Pengeluaran vs Pemasukan</h5>
                    <div style="height: 250px; width: 100%;">
                        <canvas id="financeChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-0 pt-4">
                    <h5 class="fw-bold text-dark">Riwayat Terakhir</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">Tanggal & Jam</th>
                                    <th>Kategori</th>
                                    <th>Tipe</th>
                                    <th class="text-end pe-4">Jumlah</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for t in transactions %}
                                <tr>
                                    <td class="ps-4 text-muted small">
                                        <div class="fw-bold text-dark">{{ t.date|date:"d M Y" }}</div>
                                        <div style="font-size: 0.85em; color: #666;">
                                            ðŸ•’ {{ t.date|date:"H:i" }} WIB
                                        </div>
                                    </td>
                                    
                                    <td class="fw-500">{{ t.category }}</td>
                                    <td>
                                        {% if t.type == 'IN' %}
                                            <span class="badge bg-success-subtle text-success border border-success px-3 rounded-pill">Masuk</span>
                                        {% else %}
                                            <span class="badge bg-danger-subtle text-danger border border-danger px-3 rounded-pill">Keluar</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end pe-4 fw-bold {% if t.type == 'IN' %}text-success{% else %}text-danger{% endif %}">
                                        Rp {{ t.amount|intcomma }}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="4" class="text-center py-4 text-muted">Belum ada transaksi. Yuk mulai catat!</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ctx = document.getElementById('financeChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Pemasukan', 'Pengeluaran'],
                datasets: [{
                    data: [{{ total_income }}, {{ total_expense }}],
                    backgroundColor: ['#10b981', '#ef4444'], 
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                },
                layout: {
                    padding: 20
                }
            }
        });
    </script>

{% endblock %}